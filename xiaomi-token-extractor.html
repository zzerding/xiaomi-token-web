<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xiaomi Cloud Tokens Extractor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff6900;
            --primary-dark: #e55a00;
            --primary-light: #ff8533;
            --bg: #000000;
            --bg-secondary: #111111;
            --card-bg: #000000;
            --card-bg-hover: #0a0a0a;
            --text: #ffffff;
            --text-secondary: #888888;
            --text-muted: #666666;
            --border: #333333;
            --border-light: #222222;
            --border-hover: #444444;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.3);
            --shadow-xl: 0 20px 60px rgba(0,0,0,0.5);
            --radius: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --gradient: linear-gradient(135deg, #ff6900 0%, #ff8533 100%);
            --gradient-dark: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 105, 0, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 105, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(255, 133, 51, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            margin-bottom: 4rem;
            position: relative;
        }
        
        h1 {
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 1rem;
            background: linear-gradient(to bottom right, #ffffff 30%, var(--primary) 70%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            animation: fadeInUp 0.8s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 1.25rem;
            font-weight: 400;
            letter-spacing: -0.01em;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }
        
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: 2.5rem;
            margin-bottom: 2rem;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .card:hover {
            border-color: var(--border-hover);
            background: var(--card-bg-hover);
            transform: translateY(-2px);
        }
        
        .card:hover::before {
            opacity: 1;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-light);
        }
        
        .card-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .card-icon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            transform: translate(-50%, -50%);
        }
        
        .card h2 {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text);
            letter-spacing: -0.01em;
        }
        
        .auth-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2.5rem;
        }
        
        .auth-tab {
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 400;
            cursor: pointer;
            transition: color 0.2s ease;
            display: inline-block;
            box-shadow: none;
            transform: none;
        }
        
        .auth-tab:hover {
            color: var(--text);
            transform: none;
            box-shadow: none;
        }
        
        .auth-tab:active {
            transform: none;
        }
        
        .auth-tab.active {
            color: var(--text);
            font-weight: 500;
        }
        
        .auth-content {
            display: none;
        }
        
        .auth-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg);
            color: var(--text);
            font-size: 0.875rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 105, 0, 0.1);
        }
        
        .form-group small {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        button[type="submit"] {
            width: 100%;
        }
        
        .button-secondary {
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .button-secondary:hover {
            background: var(--border-light);
        }
        
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-xl);
            padding: 4rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--bg-secondary);
            position: relative;
            overflow: hidden;
        }
        
        .drop-zone::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, var(--primary) 0%, transparent 70%);
            transform: translate(-50%, -50%) scale(0);
            opacity: 0.1;
            transition: transform 0.5s ease;
        }
        
        .drop-zone:hover::before,
        .drop-zone.drag-over::before {
            transform: translate(-50%, -50%) scale(1);
        }
        
        .drop-zone:hover,
        .drop-zone.drag-over {
            border-color: var(--primary);
            background: var(--bg-secondary);
        }
        
        .drop-zone-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            filter: grayscale(100%);
            opacity: 0.3;
            transition: all 0.3s ease;
        }
        
        .drop-zone:hover .drop-zone-icon {
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.1);
        }
        
        #alerts {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: 400px;
            pointer-events: none;
        }
        
        .alert {
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: slideInRight 0.3s ease-out;
            box-shadow: var(--shadow-lg);
            pointer-events: auto;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .alert.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .alert.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .alert.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .alert.info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-container {
            margin: 1rem 0;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        
        .progress-message {
            text-align: center;
            margin-bottom: 0.75rem;
            font-weight: 500;
            color: var(--text);
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .device-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            transition: all 0.2s ease;
        }
        
        .device-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-lg);
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .device-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text);
            margin-bottom: 0.25rem;
        }
        
        .device-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        
        .status-dot.online {
            background: var(--success);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        
        .device-info {
            space-y: 0.75rem;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-row dt {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }
        
        .info-row dd {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 0.75rem;
            color: var(--text);
            background: var(--bg-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            max-width: 200px;
            text-align: right;
            word-break: break-all;
            position: relative;
        }
        
        .info-row dd:hover {
            background: var(--primary);
            color: white;
        }
        
        .info-row dd.token {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            font-weight: 500;
        }
        
        .copy-hint {
            position: absolute;
            top: -2rem;
            right: 0;
            background: var(--bg);
            color: var(--text-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            font-size: 0.625rem;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            white-space: nowrap;
            z-index: 10;
        }
        
        .info-row dd:hover .copy-hint {
            opacity: 1;
        }
        
        /* 2FA Manual Input Style */
        #manual2faInput {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 1.25rem;
            letter-spacing: 0.5em;
            text-align: center;
            font-weight: 600;
        }
        
        /* 2FA URL overflow fix */
        #verifyUrl {
            word-break: break-all;
            display: inline-block;
            max-width: 100%;
        }
        
        .privacy-notice {
            margin-top: 3rem;
            padding: 1.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }
        
        .privacy-notice h3 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            color: var(--text);
            font-size: 1.1rem;
        }
        
        .privacy-notice .icon {
            font-size: 1.25rem;
        }
        
        .privacy-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .privacy-section h4 {
            color: var(--text);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .privacy-section p {
            color: var(--text-secondary);
            font-size: 0.8rem;
            line-height: 1.5;
        }
        
        .footer {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8125rem;
        }
        
        .footer p {
            margin-bottom: 0.5rem;
        }
        
        .footer a {
            color: var(--primary);
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        .language-switcher {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
        }
        
        .language-switcher button {
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            box-shadow: var(--shadow);
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
            
            .container {
                padding: 1rem;
                max-width: 100%;
            }
            
            .header {
                margin-bottom: 2rem;
            }
            
            .header h1 {
                font-size: 1.75rem;
            }
            
            .header .subtitle {
                font-size: 0.875rem;
            }
            
            .card {
                padding: 1.25rem;
                margin-bottom: 1rem;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
                margin-bottom: 1rem;
            }
            
            .card-header > div:first-child {
                flex-direction: row;
                align-items: center;
            }
            
            .card-header > div:last-child {
                margin-top: 0;
                width: 100%;
            }
            
            .card-header button {
                width: auto;
                flex: 1;
            }
            
            /* Stack server controls on mobile */
            #devicesSection .card-header > div:last-child {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }
            
            #serverSelector, #refreshDevicesBtn {
                width: 100% !important;
                margin: 0 !important;
            }
            
            .devices-grid {
                grid-template-columns: 1fr;
            }
            
            .language-switcher {
                position: static;
                margin-bottom: 1rem;
                text-align: center;
            }
            
            .privacy-content {
                grid-template-columns: 1fr;
            }
            
            /* Adjust alerts position on mobile */
            #alerts {
                top: 4rem;
                right: 0.5rem;
                left: 0.5rem;
                max-width: calc(100% - 1rem);
            }
        }
    </style>
</head>
<body>
    <!-- Alerts container (fixed position) -->
    <div id="alerts"></div>
    
    <div class="language-switcher">
        <button onclick="switchLanguage()">中文</button>
    </div>

    <div class="container">
        <div class="header">
            <h1 id="pageTitle">Xiaomi Cloud Tokens Extractor</h1>
            <p class="subtitle" id="pageSubtitle">Extract device tokens and keys from your Xiaomi account</p>
        </div>
        
        <div id="authCard" class="card">
            <div class="card-header">
                <div class="card-icon">🔐</div>
                <h2 id="authTitle">Authentication</h2>
            </div>
            <div class="card-content">
                <div id="authTabs" class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('login')" id="loginTabBtn">Login with Credentials</button>
                    <button class="auth-tab" onclick="switchAuthTab('session')" id="sessionTabBtn">Use Saved Session</button>
                </div>
                
                <div id="loginTab" class="auth-content active">
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="username" id="usernameLabel">Username</label>
                            <input type="text" id="username" name="username" placeholder="Email, phone number, or Xiaomi ID" required>
                            <small id="usernameHint">Accepts: Email address, phone number (mostly CN accounts), or Xiaomi account ID</small>
                        </div>
                        <div class="form-group">
                            <label for="password" id="passwordLabel">Password</label>
                            <input type="password" id="password" name="password" required>
                        </div>
                        <div class="form-group">
                            <label for="server" id="serverLabel">Server Region</label>
                            <select id="server" name="server" title="Choose the region where you created your Xiaomi account or where your devices were purchased">
                                <option value="cn">🇨🇳 China (cn) - Mainland China</option>
                                <option value="de">🇩🇪 Germany (de) - Europe</option>
                                <option value="us">🇺🇸 United States (us) - Americas</option>
                                <option value="ru">🇷🇺 Russia (ru) - Russia/CIS</option>
                                <option value="tw">🇹🇼 Taiwan (tw) - Taiwan</option>
                                <option value="sg">🇸🇬 Singapore (sg) - Southeast Asia</option>
                                <option value="in">🇮🇳 India (in) - India</option>
                                <option value="i2">🌍 International (i2) - Other regions</option>
                            </select>
                            <small style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.25rem; display: block;" id="serverHint">
                                💡 Choose the region where you created your Xiaomi account or where your devices were purchased<br>
                                You can switch to other regions after login without re-authenticating
                            </small>
                        </div>
                        <button type="submit" id="loginBtn">Login</button>
                    </form>
                </div>
                
                <div id="sessionTab" class="auth-content">
                    <div id="dropZone" class="drop-zone">
                        <div class="drop-zone-icon">📁</div>
                        <h3 style="margin-bottom: 0.5rem;" id="dropZoneTitle">Drop session file here</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;" id="dropZoneSubtitle">or click to browse</p>
                        <input type="file" id="loadSession" accept=".json" style="display: none;">
                        <button class="button-secondary" onclick="document.getElementById('loadSession').click()" id="chooseFileBtn">
                            Choose File
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="verifySection" class="card hidden">
            <div class="card-header">
                <div class="card-icon">🔐</div>
                <h2 id="twoFactorTitle">Two-Factor Authentication</h2>
            </div>
            <div class="card-content">
                <p style="margin-bottom: 1rem;" id="twoFactorSteps">Please follow these steps:</p>
                <ol style="margin-bottom: 1.5rem; padding-left: 1.5rem; color: var(--text-secondary);">
                    <li style="margin-bottom: 0.5rem;" id="twoFactorStep1">Open this URL in your browser: <a id="verifyUrl" href="#" target="_blank" style="color: var(--primary);"></a></li>
                    <li style="margin-bottom: 0.5rem;" id="twoFactorStep2">Choose your verification method (SMS or Email)</li>
                    <li style="margin-bottom: 0.5rem;" id="twoFactorStep3">You'll receive a 6-digit verification code</li>
                    <li style="margin-bottom: 0.5rem; background: rgba(239, 68, 68, 0.1); padding: 0.5rem; border-radius: 0.25rem; border-left: 3px solid var(--error); color: var(--text); font-weight: 600;" id="twoFactorStep4">⚠️ DO NOT enter the code on Xiaomi's website! Close the browser instead.</li>
                    <li style="margin-bottom: 0.5rem;" id="twoFactorStep5">Enter the verification code in the field below</li>
                </ol>
                <div id="verifyFormContainer">
                    <div class="form-group">
                        <label id="verificationCodeLabel">Verification Code</label>
                        <input type="text" id="manual2faInput" name="manual2fa-xiaomi-token" placeholder="Enter 6 digits" maxlength="6" pattern="[0-9]{6}" required autocomplete="off" data-lpignore="true" data-form-type="other" data-1p-ignore="true" data-bwignore="true">
                    </div>
                    <button id="verifyBtn" type="button">Verify</button>
                </div>
            </div>
        </div>
        
        <div id="devicesSection" class="card hidden">
            <div class="card-header" style="margin-bottom: 0; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center;">
                    <div class="card-icon">📱</div>
                    <h2 style="margin-bottom: 0;" id="devicesTitle">Devices</h2>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <select id="serverSelector" style="padding: 0.5rem 1rem; padding-right: 2.5rem; font-size: 0.875rem; border: 1px solid var(--border); border-radius: var(--radius); background-color: var(--bg-secondary); color: var(--text); height: 36px; -webkit-appearance: none; appearance: none; background-image: url(&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M10.293 3.293L6 7.586 1.707 3.293A1 1 0 00.293 4.707l5 5a1 1 0 001.414 0l5-5a1 1 0 10-1.414-1.414z'/%3E%3C/svg%3E&quot;); background-repeat: no-repeat; background-position: right 0.5rem center;" onchange="loadDevices(false)" title="Choose the region where you created your Xiaomi account or where your devices were purchased">
                        <option value="cn">🇨🇳 China (cn) - Mainland China</option>
                        <option value="de">🇩🇪 Germany (de) - Europe</option>
                        <option value="us">🇺🇸 United States (us) - Americas</option>
                        <option value="ru">🇷🇺 Russia (ru) - Russia/CIS</option>
                        <option value="tw">🇹🇼 Taiwan (tw) - Taiwan</option>
                        <option value="sg">🇸🇬 Singapore (sg) - Southeast Asia</option>
                        <option value="in">🇮🇳 India (in) - India</option>
                        <option value="i2">🌍 International (i2) - Other regions</option>
                    </select>
                    <button id="refreshDevicesBtn" class="button-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem; white-space: nowrap; height: 36px;" onclick="loadDevices(false)">🔄 <span id="refreshText">Refresh</span></button>
                </div>
            </div>
            <div id="currentServerInfo" style="margin: 1rem 0; padding: 0.75rem; background: var(--bg); border-radius: var(--radius); font-size: 0.875rem; color: var(--text-secondary); text-align: center;"></div>
            <div id="devicesList" class="devices-grid"></div>
        </div>
        
        <div class="privacy-notice">
            <h3><span class="icon">🔒</span> <span id="privacyTitle">Privacy & Security Disclosure</span></h3>
            <div class="privacy-content">
                <div class="privacy-section">
                    <h4 id="privacyWhat">What This Tool Does</h4>
                    <p id="privacyWhatDesc">This tool extracts device tokens and authentication keys from your Xiaomi account. These tokens are used to locally control your Xiaomi smart home devices without going through Xiaomi's cloud servers.</p>
                </div>
                
                <div class="privacy-section">
                    <h4 id="privacyHow">How It Works</h4>
                    <p id="privacyHowDesc">Direct communication with Xiaomi servers, no data stored on our servers.</p>
                </div>
                
                <div class="privacy-section">
                    <h4 id="privacyWhere">Data Location</h4>
                    <p id="privacyWhereDesc">All processing happens locally in your browser. Session files remain on your device.</p>
                </div>
                
                <div class="privacy-section">
                    <h4 id="privacyWhy">Why Use This Tool</h4>
                    <p id="privacyWhyDesc">Extract tokens for local device control without cloud dependency.</p>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p id="footerText">This is an unofficial tool not affiliated with Xiaomi. Use at your own risk.</p>
            <div class="footer-links" style="margin: 1rem 0;">
                <a href="https://github.com/rankjie/xiaomi-tokens-web" target="_blank" id="githubLink">
                    GitHub
                </a>
            </div>
            <p id="footerVersion">VERSION 1.3.0</p>
        </div>
    </div>
    
    <script>
        // Debug utility (simplified version)
        const debug = {
            log: (...args) => {
                if (typeof console !== 'undefined' && console.log) {
                    console.log(...args);
                }
            },
            error: (...args) => {
                if (typeof console !== 'undefined' && console.error) {
                    console.error(...args);
                }
            },
            warn: (...args) => {
                if (typeof console !== 'undefined' && console.warn) {
                    console.warn(...args);
                }
            }
        };

        // Translations
        const translations = {
          en: {
            title: 'Xiaomi Cloud Tokens Extractor',
            subtitle: 'Extract device tokens and keys from your Xiaomi account',
            authentication: 'Authentication',
            loginTab: 'Login with Credentials',
            sessionTab: 'Use Saved Session',
            username: 'Username',
            usernamePlaceholder: 'Email, phone number, or Xiaomi ID',
            usernameHint: 'Accepts: Email address, phone number (mostly CN accounts), or Xiaomi account ID',
            password: 'Password',
            serverRegion: 'Server Region',
            serverHint1: 'Choose the region where you created your Xiaomi account or where your devices were purchased',
            serverHint2: 'You can switch to other regions after login without re-authenticating',
            login: 'Login',
            dropZoneTitle: 'Drop session file here',
            dropZoneSubtitle: 'or click to browse',
            chooseFile: 'Choose File',
            twoFactorTitle: 'Two-Factor Authentication',
            twoFactorSteps: 'Please follow these steps:',
            twoFactorStep1: 'Open this URL in your browser:',
            twoFactorStep2: 'Choose your verification method (SMS or Email)',
            twoFactorStep3: "You'll receive a 6-digit verification code",
            twoFactorStep4: 'DO NOT enter the code on Xiaomi\'s website! Enter it here instead.',
            twoFactorStep5: 'Enter the verification code in the field below',
            verificationCode: 'Verification Code',
            verificationPlaceholder: 'Enter 6 digits',
            verify: 'Verify',
            devices: 'Devices',
            authenticatedSession: 'Authenticated Session',
            user: 'USER',
            id: 'ID',
            session: 'SESSION',
            saveSession: 'Save Session',
            changeAccount: 'Change Account',
            refresh: 'Refresh',
            loadingDevices: 'Loading devices from',
            noDevicesFound: 'No devices found in',
            scanningRegion: 'Scanning',
            scanningProgress: 'region...',
            foundDevices: 'Found',
            devicesIn: 'device(s) in',
            showing: 'Showing',
            devicesFrom: 'device(s) from',
            online: 'Online',
            offline: 'Offline',
            clickToCopy: 'Click to copy',
            privacyTitle: 'Privacy & Security Disclosure',
            privacyWhat: 'What This Tool Does',
            privacyWhatDesc: 'This tool extracts device tokens and authentication keys from your Xiaomi account. These tokens are used to locally control your Xiaomi smart home devices without going through Xiaomi\'s cloud servers.',
            privacyHow: 'How It Works',
            privacyHowDesc: 'Direct communication with Xiaomi servers, no data stored on our servers.',
            privacyWhere: 'Data Location',
            privacyWhereDesc: 'All processing happens locally in your browser. Session files remain on your device.',
            privacyWhy: 'Why Use This Tool',
            privacyWhyDesc: 'Super easy web interface - no need to install Python or run scripts. Extract tokens for local device control without cloud dependency.',
            disclaimer: 'Disclaimer:',
            disclaimerText: 'This is an unofficial tool not affiliated with Xiaomi. Use at your own risk.',
            version: 'VERSION',
            githubLink: 'GitHub',
            pythonLink: 'Original Python Version',
            model: 'Model',
            did: 'DID',
            token: 'Token',
            ip: 'IP',
            mac: 'MAC',
            bleKey: 'BLE Key',
            wifi: 'WiFi',
            unknownDevice: 'Unknown Device',
            loginSuccessful: 'Login successful!',
            verificationRequired: '2FA verification required',
            verificationSuccessful: '2FA verification successful!',
            sessionLoaded: 'Session loaded, validating...',
            sessionValid: 'Session is valid!',
            sessionExpired: 'Session expired, please login again',
            invalidSessionFile: 'Invalid session file',
            sessionSaved: 'Session saved successfully',
            failedToCopy: 'Failed to copy to clipboard',
            error: 'Error',
            warning: 'Warning',
            info: 'Info',
            success: 'Success',
            noDevicesInAnyRegion: 'No devices found in any region. Your devices might be offline or not yet registered.',
            searchingDevices: 'Searching for devices...',
            // Region names
            regionChina: '🇨🇳 China (cn) - Mainland China',
            regionGermany: '🇩🇪 Germany (de) - Europe',
            regionUS: '🇺🇸 United States (us) - Americas',
            regionRussia: '🇷🇺 Russia (ru) - Russia/CIS',
            regionTaiwan: '🇹🇼 Taiwan (tw) - Taiwan',
            regionSingapore: '🇸🇬 Singapore (sg) - Southeast Asia',
            regionIndia: '🇮🇳 India (in) - India',
            regionInternational: '🌍 International (i2) - Other regions',
            // Additional translation keys for JavaScript
            pleaseDropJsonFile: 'Please drop a JSON file',
            sessionNotFound: 'Session not found. Please login again.',
            verificationSuccessful2FA: '2FA verification successful!',
            sessionExpiredLogin: 'Session expired, please login again',
            foundDevicesCount: 'Found',
            deviceCount: 'device(s)',
            errorMessage: 'Error:',
            loginFailed: 'Login failed:',
            verificationFailed: 'Verification failed:',
            foundDevicesInRegion: 'Found',
            inRegion: 'device(s) in',
            regionUpper: 'region!',
            noDevicesAnyRegion: 'No devices found in any region',
            loadingDevicesFrom: 'Loading devices from',
            server: 'server...',
            showingDevicesFrom: 'Showing',
            devicesSuffix: 'device(s) from',
            serverText: 'server',
            errorLoadingFrom: 'Error loading from',
            footerText: 'This is an unofficial tool not affiliated with Xiaomi. Use at your own risk.',
            footerVersion: 'VERSION 1.3.0',
            languageSwitch: '中文'
          },
          zh: {
            title: '小米云令牌提取器',
            subtitle: '从您的小米账户提取设备令牌和密钥',
            authentication: '身份验证',
            loginTab: '使用账号密码登录',
            sessionTab: '使用已保存的会话',
            username: '用户名',
            usernamePlaceholder: '邮箱、手机号或小米ID',
            usernameHint: '支持：邮箱地址、手机号（主要是国内账号）或小米账号ID',
            password: '密码',
            serverRegion: '服务器区域',
            serverHint1: '选择您创建小米账户或购买设备的区域',
            serverHint2: '登录后可以切换到其他区域而无需重新验证',
            login: '登录',
            dropZoneTitle: '将会话文件拖放到此处',
            dropZoneSubtitle: '或点击浏览',
            chooseFile: '选择文件',
            twoFactorTitle: '两步验证',
            twoFactorSteps: '请按照以下步骤操作：',
            twoFactorStep1: '在浏览器中打开此链接：',
            twoFactorStep2: '选择您的验证方式（短信或邮箱）',
            twoFactorStep3: '您将收到6位验证码',
            twoFactorStep4: '请勿在小米官网输入验证码！请在此处输入。',
            twoFactorStep5: '在下方输入收到的验证码',
            verificationCode: '验证码',
            verificationPlaceholder: '输入6位数字',
            verify: '验证',
            devices: '设备',
            authenticatedSession: '已认证会话',
            user: '用户',
            id: 'ID',
            session: '会话',
            saveSession: '保存会话',
            changeAccount: '更换账号',
            refresh: '刷新',
            loadingDevices: '正在从以下服务器加载设备',
            noDevicesFound: '在以下区域未找到设备',
            scanningRegion: '正在扫描',
            scanningProgress: '区域...',
            foundDevices: '在',
            devicesIn: '找到',
            showing: '显示来自',
            devicesFrom: '服务器的',
            online: '在线',
            offline: '离线',
            clickToCopy: '点击复制',
            privacyTitle: '隐私与安全声明',
            privacyWhat: '工具功能',
            privacyWhatDesc: '此工具从您的小米账户提取设备令牌和认证密钥。这些令牌用于在本地控制您的小米智能家居设备，无需通过小米云服务器。',
            privacyHow: '工作原理',
            privacyHowDesc: '直接与小米服务器通信，我们的服务器不存储任何数据。',
            privacyWhere: '数据位置',
            privacyWhereDesc: '所有处理都在您的浏览器中本地进行。会话文件保留在您的设备上。',
            privacyWhy: '使用原因',
            privacyWhyDesc: '超级简单的网页界面 - 无需安装Python或运行脚本。提取令牌用于本地设备控制，无需依赖云服务。',
            disclaimer: '免责声明：',
            disclaimerText: '这是一个非官方工具，与小米公司无关。使用风险自负。',
            version: '版本',
            githubLink: 'GitHub',
            pythonLink: '原始Python版本',
            model: '型号',
            did: 'DID',
            token: 'Token',
            ip: 'IP',
            mac: 'MAC',
            bleKey: 'BLE密钥',
            wifi: 'WiFi',
            unknownDevice: '未知设备',
            loginSuccessful: '登录成功！',
            verificationRequired: '需要两步验证',
            verificationSuccessful: '两步验证成功！',
            sessionLoaded: '会话已加载，正在验证...',
            sessionValid: '会话有效！',
            sessionExpired: '会话已过期，请重新登录',
            invalidSessionFile: '无效的会话文件',
            sessionSaved: '会话保存成功',
            failedToCopy: '复制到剪贴板失败',
            error: '错误',
            warning: '警告',
            info: '信息',
            success: '成功',
            noDevicesInAnyRegion: '在任何区域都未找到设备。您的设备可能离线或尚未注册。',
            searchingDevices: '正在搜索设备...',
            // Region names
            regionChina: '🇨🇳 中国 (cn) - 中国大陆',
            regionGermany: '🇩🇪 德国 (de) - 欧洲',
            regionUS: '🇺🇸 美国 (us) - 美洲',
            regionRussia: '🇷🇺 俄罗斯 (ru) - 俄罗斯/独联体',
            regionTaiwan: '🇹🇼 台湾 (tw) - 台湾地区',
            regionSingapore: '🇸🇬 新加坡 (sg) - 东南亚',
            regionIndia: '🇮🇳 印度 (in) - 印度',
            regionInternational: '🌍 国际 (i2) - 其他地区',
            // Additional translation keys for JavaScript
            pleaseDropJsonFile: '请拖放一个JSON文件',
            sessionNotFound: '未找到会话。请重新登录。',
            verificationSuccessful2FA: '两步验证成功！',
            sessionExpiredLogin: '会话已过期，请重新登录',
            foundDevicesCount: '找到',
            deviceCount: '个设备',
            errorMessage: '错误：',
            loginFailed: '登录失败：',
            verificationFailed: '验证失败：',
            foundDevicesInRegion: '在',
            inRegion: '区域找到',
            regionUpper: '个设备！',
            noDevicesAnyRegion: '在任何区域都未找到设备',
            loadingDevicesFrom: '正在从',
            server: '服务器加载设备...',
            showingDevicesFrom: '显示来自',
            devicesSuffix: '个设备',
            serverText: '服务器',
            errorLoadingFrom: '从以下位置加载时出错',
            footerText: '这是一个非官方工具，与小米公司无关。使用风险自负。',
            footerVersion: '版本 1.3.0',
            languageSwitch: 'English'
          }
        };

        // Set current language based on URL or default
        let currentLang = 'en';

        // Translation function
        function t(key) {
            return translations[currentLang]?.[key] || translations.en[key] || key;
        }

        // Update all UI text based on current language
        function updateUIText() {
            // Update page title and subtitle
            document.getElementById('pageTitle').textContent = t('title');
            document.getElementById('pageSubtitle').textContent = t('subtitle');
            document.title = t('title');
            
            // Update authentication section
            document.getElementById('authTitle').textContent = t('authentication');
            document.getElementById('loginTabBtn').textContent = t('loginTab');
            document.getElementById('sessionTabBtn').textContent = t('sessionTab');
            
            // Update login form
            document.getElementById('usernameLabel').textContent = t('username');
            document.getElementById('username').placeholder = t('usernamePlaceholder');
            document.getElementById('usernameHint').textContent = t('usernameHint');
            document.getElementById('passwordLabel').textContent = t('password');
            document.getElementById('serverLabel').textContent = t('serverRegion');
            document.getElementById('serverHint').innerHTML = '💡 ' + t('serverHint1') + '<br>' + t('serverHint2');
            document.getElementById('loginBtn').textContent = t('login');
            
            // Update session tab
            document.getElementById('dropZoneTitle').textContent = t('dropZoneTitle');
            document.getElementById('dropZoneSubtitle').textContent = t('dropZoneSubtitle');
            document.getElementById('chooseFileBtn').textContent = t('chooseFile');
            
            // Update 2FA section
            document.getElementById('twoFactorTitle').textContent = t('twoFactorTitle');
            document.getElementById('twoFactorSteps').textContent = t('twoFactorSteps');
            document.getElementById('twoFactorStep1').innerHTML = t('twoFactorStep1') + ' <a id="verifyUrl" href="#" target="_blank" style="color: var(--primary);"></a>';
            document.getElementById('twoFactorStep2').textContent = t('twoFactorStep2');
            document.getElementById('twoFactorStep3').textContent = t('twoFactorStep3');
            document.getElementById('twoFactorStep4').innerHTML = '⚠️ ' + t('twoFactorStep4');
            document.getElementById('twoFactorStep5').textContent = t('twoFactorStep5');
            document.getElementById('verificationCodeLabel').textContent = t('verificationCode');
            const manual2faInput = document.getElementById('manual2faInput');
            if (manual2faInput) {
                manual2faInput.placeholder = t('verificationPlaceholder');
            }
            document.getElementById('verifyBtn').textContent = t('verify');
            
            // Update devices section
            document.getElementById('devicesTitle').textContent = t('devices');
            document.getElementById('refreshText').textContent = t('refresh');
            
            // Update privacy section
            document.getElementById('privacyTitle').textContent = t('privacyTitle');
            document.getElementById('privacyWhat').textContent = t('privacyWhat');
            document.getElementById('privacyWhatDesc').textContent = t('privacyWhatDesc');
            document.getElementById('privacyHow').textContent = t('privacyHow');
            document.getElementById('privacyHowDesc').textContent = t('privacyHowDesc');
            document.getElementById('privacyWhere').textContent = t('privacyWhere');
            document.getElementById('privacyWhereDesc').textContent = t('privacyWhereDesc');
            document.getElementById('privacyWhy').textContent = t('privacyWhy');
            document.getElementById('privacyWhyDesc').textContent = t('privacyWhyDesc');
            
            // Update footer
            document.getElementById('footerText').textContent = t('footerText');
            document.getElementById('footerVersion').textContent = t('footerVersion');
            document.getElementById('githubLink').textContent = t('githubLink');
            
            // Update language switcher
            document.querySelector('.language-switcher button').textContent = t('languageSwitch');
            
            // Update HTML lang attribute
            document.documentElement.lang = currentLang;
        }

        // Language switching
        function switchLanguage() {
            currentLang = currentLang === 'en' ? 'zh' : 'en';
            updateUIText();
        }

        let currentSession = null;
        let tempClientState = null; // Store client state for stateless 2FA
        let selectedServer = 'cn'; // Store selected server
        let sessionLoadedFromFile = false; // Track if session was loaded from file

        // Tab switching
        function switchAuthTab(tab) {
            const tabs = document.querySelectorAll('.auth-tab');
            const contents = document.querySelectorAll('.auth-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            if (tab === 'login') {
                tabs[0].classList.add('active');
                document.getElementById('loginTab').classList.add('active');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('sessionTab').classList.add('active');
            }
        }

        // Alert functions
        function showAlert(message, type = 'info') {
            const alertsDiv = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            
            // Add icon based on type
            const icons = {
                success: '✓',
                error: '×',
                warning: '!',
                info: 'i'
            };
            
            alert.innerHTML = `
                <span style="font-size: 1.25rem; font-weight: bold;">${icons[type] || icons.info}</span>
                <span>${message}</span>
            `;
            
            alertsDiv.appendChild(alert);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alert.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        // Add slide out animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Drag and drop setup
        const dropZone = document.getElementById('dropZone');
        const loadSessionInput = document.getElementById('loadSession');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/json') {
                handleSessionFile(files[0]);
            } else {
                showAlert(t('pleaseDropJsonFile'), 'error');
            }
        });

        dropZone.addEventListener('click', (e) => {
            // Don't trigger if clicking on the button or its children
            if (e.target.closest('button')) {
                return;
            }
            loadSessionInput.click();
        });

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const credentials = {
                username: formData.get('username'),
                password: formData.get('password'),
                server: formData.get('server')
            };
            
            // Store selected server
            selectedServer = credentials.server;
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="loading"></span> Logging in...';
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(credentials)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentSession = result.session;
                    currentSession.server = credentials.server; // Store server selection
                    sessionLoadedFromFile = false; // Not loaded from file
                    showAlert(t('loginSuccessful'), 'success');
                    updateSessionUI();
                    // Set server selector to match login selection
                    const serverSelector = document.getElementById('serverSelector');
                    if (serverSelector) {
                        serverSelector.value = credentials.server;
                    }
                    await loadDevices();
                } else if (result.requires2FA) {
                    // Store the client state for 2FA verification
                    tempClientState = result.clientState;
                    
                    const verifyUrlElement = document.getElementById('verifyUrl');
                    verifyUrlElement.textContent = result.verifyUrl;
                    verifyUrlElement.href = result.verifyUrl;
                    
                    // Hide login form and show verification section
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('verifySection').classList.remove('hidden');
                    
                    // Focus on the manual 2FA input
                    setTimeout(() => {
                        document.getElementById('manual2faInput').focus();
                    }, 100);
                    
                    showAlert(t('verificationRequired'), 'warning');
                } else {
                    showAlert(t('loginFailed') + ' ' + result.error, 'error');
                }
            } catch (error) {
                showAlert(t('errorMessage') + ' ' + error.message, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = t('login');
            }
        });

        // 2FA verification handler
        async function handle2FAVerification() {
            const manual2faInput = document.getElementById('manual2faInput');
            const code = manual2faInput ? manual2faInput.value.trim() : '';
            
            if (!code || code.length !== 6 || !/^\d{6}$/.test(code)) {
                showAlert(t('pleaseEnterValidCode'), 'error');
                manual2faInput.focus();
                return;
            }
            
            if (!tempClientState) {
                showAlert(t('sessionNotFound'), 'error');
                document.getElementById('verifySection').classList.add('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
                return;
            }
            
            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.disabled = true;
            verifyBtn.textContent = t('verifying') + '...';
            
            try {
                const response = await fetch('/api/verify-2fa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ticket: code,
                        clientState: tempClientState
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentSession = result.session;
                    currentSession.server = selectedServer; // Store server selection
                    sessionLoadedFromFile = false; // Not loaded from file
                    
                    document.getElementById('verifySection').classList.add('hidden');
                    document.getElementById('loginForm').classList.remove('hidden');
                    showAlert(t('verificationSuccessful2FA'), 'success');
                    updateSessionUI();
                    // Set server selector to match original selection
                    const serverSelector = document.getElementById('serverSelector');
                    if (serverSelector) {
                        serverSelector.value = selectedServer;
                    }
                    await loadDevices();
                } else {
                    showAlert(t('verificationFailed') + ' ' + result.error, 'error');
                    // Reset button
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = t('verify');
                }
            } catch (error) {
                showAlert(t('errorMessage') + ' ' + error.message, 'error');
                // Reset button
                verifyBtn.disabled = false;
                verifyBtn.textContent = t('verify');
            }
        }
        
        // Add click handler for verify button
        document.getElementById('verifyBtn').addEventListener('click', handle2FAVerification);
        
        // Handle Enter key in manual 2FA input
        document.getElementById('manual2faInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handle2FAVerification();
            }
        });

        // Load session file
        document.getElementById('loadSession').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            handleSessionFile(file);
        });

        // Handle session file
        async function handleSessionFile(file) {
            try {
                const text = await file.text();
                const session = JSON.parse(text);
                
                // Convert Python session format to web format
                if (session.timestamp && !session.savedAt) {
                    session.savedAt = new Date(session.timestamp * 1000).toISOString();
                }
                if (session.device_id && !session.deviceId) {
                    session.deviceId = session.device_id;
                }
                
                currentSession = session;
                sessionLoadedFromFile = true; // Mark as loaded from file
                updateSessionUI();
                
                // Validate and load devices
                showAlert(t('sessionLoaded'), 'info');
                const response = await fetch('/api/validate-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionData: currentSession })
                });
                
                const result = await response.json();
                if (result.valid) {
                    showAlert(t('sessionValid'), 'success');
                    // Set server selector to loaded session's server if available
                    const serverSelector = document.getElementById('serverSelector');
                    if (serverSelector && currentSession.server) {
                        serverSelector.value = currentSession.server;
                    }
                    await loadDevices();
                } else {
                    showAlert(t('sessionExpiredLogin'), 'error');
                    currentSession = null;
                    updateSessionUI();
                }
            } catch (error) {
                showAlert(t('invalidSessionFile'), 'error');
            }
        }

        // Logout function
        function logout() {
            currentSession = null;
            tempClientState = null;
            selectedServer = 'cn';
            sessionLoadedFromFile = false;
            location.reload();
        }

        // Save session
        function saveSession() {
            if (!currentSession) return;
            
            const filename = `${currentSession.username}_xiaomi_session_${new Date().toISOString().split('T')[0]}.json`;
            const blob = new Blob([JSON.stringify(currentSession, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            
            URL.revokeObjectURL(url);
            showAlert(t('sessionSaved'), 'success');
        }

        // Update session UI
        function updateSessionUI() {
            const authCard = document.getElementById('authCard');
            const authTabs = document.querySelector('.auth-tabs');
            const authContents = document.querySelectorAll('.auth-content');
            const devicesSection = document.getElementById('devicesSection');
            
            if (currentSession) {
                // Hide tabs and auth content when logged in
                authTabs.style.display = 'none';
                authContents.forEach(content => content.style.display = 'none');
                
                // Create collapsed session view
                const savedAt = currentSession.savedAt ? new Date(currentSession.savedAt).toLocaleString() : 'Unknown';
                
                // Find the card-content div and update it
                const cardContent = authCard.querySelector('.card-content');
                if (cardContent) {
                    // Hide the original content
                    cardContent.style.display = 'none';
                }
                
                // Update the card header
                const cardHeader = authCard.querySelector('.card-header');
                if (cardHeader) {
                    cardHeader.innerHTML = `
                        <div style="display: flex; align-items: center;">
                            <div class="card-icon">🔐</div>
                            <div style="margin-left: 1rem;">
                                <h2 style="margin-bottom: 0.25rem;">${t('authenticatedSession')}</h2>
                                <div style="display: flex; gap: 1.5rem; font-size: 0.8125rem; color: var(--text-secondary); font-weight: 400;">
                                    <span style="display: flex; align-items: center; gap: 0.25rem;">
                                        <span style="color: var(--text-muted); text-transform: uppercase; font-size: 0.6875rem; letter-spacing: 0.05em;">${t('user')}</span>
                                        <span style="color: var(--text-secondary);">${currentSession.username}</span>
                                    </span>
                                    <span style="display: flex; align-items: center; gap: 0.25rem;">
                                        <span style="color: var(--text-muted); text-transform: uppercase; font-size: 0.6875rem; letter-spacing: 0.05em;">${t('id')}</span>
                                        <span style="color: var(--text-secondary);">${currentSession.userId}</span>
                                    </span>
                                    <span style="display: flex; align-items: center; gap: 0.25rem;">
                                        <span style="color: var(--text-muted); text-transform: uppercase; font-size: 0.6875rem; letter-spacing: 0.05em;">${t('session')}</span>
                                        <span style="color: var(--text-secondary);">${savedAt}</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            ${!sessionLoadedFromFile ? `
                                <button id="saveSessionBtnTop" class="button-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="saveSession()">
                                    💾 ${t('saveSession')}
                                </button>
                            ` : ''}
                            <button class="button-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="logout()">
                                🔄 ${t('changeAccount')}
                            </button>
                        </div>
                    `;
                    cardHeader.style.justifyContent = 'space-between';
                    cardHeader.style.alignItems = 'center';
                    cardHeader.style.marginBottom = '0';
                }
                
                devicesSection.classList.remove('hidden');
            } else {
                // Restore original UI without reloading
                authTabs.style.display = 'flex';
                
                // Reset auth tabs to login tab
                const authTabButtons = authTabs.querySelectorAll('.auth-tab');
                authTabButtons.forEach((tab, index) => {
                    if (index === 0) { // First tab is login
                        tab.classList.add('active');
                    } else {
                        tab.classList.remove('active');
                    }
                });
                
                authContents.forEach(content => {
                    if (content.id === 'loginTab') {
                        content.classList.add('active');
                        content.style.display = 'block';
                    } else {
                        content.classList.remove('active');
                        content.style.display = 'none';
                    }
                });
                
                // Show the card content again
                const cardContent = authCard.querySelector('.card-content');
                if (cardContent) {
                    cardContent.style.display = '';
                }
                
                // Restore the original card header
                const cardHeader = authCard.querySelector('.card-header');
                if (cardHeader) {
                    cardHeader.innerHTML = `
                        <div class="card-icon">🔐</div>
                        <h2 id="authTitle">${t('authentication')}</h2>
                    `;
                    cardHeader.style.justifyContent = '';
                    cardHeader.style.alignItems = '';
                    cardHeader.style.marginBottom = '';
                }
                
                devicesSection.classList.add('hidden');
                
                // Reset session data
                sessionLoadedFromFile = false;
            }
        }

        // Track if devices are currently loading
        let isLoadingDevices = false;

        // All available regions
        const allRegions = ['cn', 'de', 'us', 'ru', 'tw', 'sg', 'in', 'i2'];

        // Load devices with streaming
        async function loadDevices(autoScan = true) {
            if (!currentSession) return;
            
            // Prevent multiple simultaneous loads
            if (isLoadingDevices) {
                debug.log('Already loading devices, skipping...');
                return;
            }
            
            const btn = document.getElementById('refreshDevicesBtn');
            const devicesList = document.getElementById('devicesList');
            const devicesSection = document.getElementById('devicesSection');
            const serverSelector = document.getElementById('serverSelector');
            
            // Get selected server
            const selectedServer = serverSelector.value;
            
            // Update server info
            const serverInfo = document.getElementById('currentServerInfo');
            serverInfo.textContent = t('loadingDevicesFrom') + ' ' + selectedServer.toUpperCase() + ' ' + t('server');
            
            isLoadingDevices = true;
            btn.disabled = true;
            serverSelector.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Loading...';
            devicesList.innerHTML = '';
            
            // Add progress container
            const progressContainer = document.createElement('div');
            progressContainer.className = 'progress-container';
            progressContainer.innerHTML = `
                <div class="progress-message">Initializing...</div>
                <div class="progress-bar">
                    <div class="progress-bar-fill" style="width: 0%"></div>
                </div>
            `;
            devicesList.appendChild(progressContainer);
            devicesSection.classList.remove('hidden');
            
            const progressMessage = progressContainer.querySelector('.progress-message');
            const progressBar = progressContainer.querySelector('.progress-bar-fill');
            
            try {
                const response = await fetch('/api/devices-stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionData: currentSession,
                        server: selectedServer
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let devices = [];
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                switch (data.type) {
                                    case 'status':
                                        progressMessage.textContent = data.message;
                                        break;
                                        
                                    case 'progress':
                                        progressMessage.textContent = data.message;
                                        if (data.totalHomes) {
                                            const percent = (data.currentHome / data.totalHomes) * 100;
                                            progressBar.style.width = `${percent}%`;
                                        }
                                        if (data.device) {
                                            devices.push(data.device);
                                            displayDevice(data.device, devicesList);
                                        }
                                        break;
                                        
                                    case 'complete':
                                        progressContainer.remove();
                                        if (devices.length === 0 && data.devices) {
                                            displayDevices(data.devices);
                                        }
                                        const deviceCount = data.devices?.length || devices.length;
                                        
                                        // If no devices found and autoScan is enabled, try other regions
                                        if (deviceCount === 0 && autoScan) {
                                            progressContainer.remove();
                                            await scanAllRegions(selectedServer);
                                        } else {
                                            showAlert(t('foundDevicesCount') + ' ' + deviceCount + ' ' + t('deviceCount'), 'success');
                                            serverInfo.textContent = t('showingDevicesFrom') + ' ' + selectedServer.toUpperCase() + ' ' + t('serverText') + ' ' + deviceCount + ' ' + t('devicesSuffix');
                                        }
                                        break;
                                        
                                    case 'error':
                                        progressContainer.remove();
                                        showAlert(t('errorMessage') + ' ' + data.message, 'error');
                                        break;
                                }
                            } catch (e) {
                                // debug.error('Failed to parse SSE data:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                progressContainer.remove();
                showAlert(t('errorLoadingDevices') + ' ' + error.message, 'error');
                serverInfo.textContent = t('errorLoadingFrom') + ' ' + selectedServer.toUpperCase() + ' ' + t('serverText');
            } finally {
                isLoadingDevices = false;
                btn.disabled = false;
                serverSelector.disabled = false;
                btn.innerHTML = '🔄 ' + t('refresh');
            }
        }

        // Scan all regions for devices
        async function scanAllRegions(currentRegion) {
            const serverInfo = document.getElementById('currentServerInfo');
            const devicesList = document.getElementById('devicesList');
            const serverSelector = document.getElementById('serverSelector');
            const btn = document.getElementById('refreshDevicesBtn');
            
            // Get regions to scan (exclude current region)
            const regionsToScan = allRegions.filter(r => r !== currentRegion);
            
            serverInfo.innerHTML = `<strong>No devices found in ${currentRegion.toUpperCase()}. Scanning other regions...</strong>`;
            
            // Disable controls during scan
            btn.disabled = true;
            serverSelector.disabled = true;
            
            let foundDevices = false;
            
            for (let i = 0; i < regionsToScan.length; i++) {
                const region = regionsToScan[i];
                serverInfo.innerHTML = `<strong>Scanning ${region.toUpperCase()} region... (${i + 1}/${regionsToScan.length})</strong>`;
                
                // Update the select box to show current scanning region
                serverSelector.value = region;
                
                try {
                    const response = await fetch('/api/devices', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionData: currentSession,
                            server: region
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.devices && result.devices.length > 0) {
                        // Found devices in this region!
                        foundDevices = true;
                        serverSelector.value = region; // Update selector to found region
                        displayDevices(result.devices);
                        showAlert(t('foundDevicesInRegion') + ' ' + region.toUpperCase() + ' ' + t('inRegion') + ' ' + result.devices.length + ' ' + t('regionUpper'), 'success');
                        serverInfo.textContent = t('showingDevicesFrom') + ' ' + region.toUpperCase() + ' ' + t('serverText') + ' ' + result.devices.length + ' ' + t('devicesSuffix');
                        break;
                    }
                } catch (error) {
                    debug.error(`Error scanning ${region}:`, error);
                }
            }
            
            if (!foundDevices) {
                serverInfo.innerHTML = '<span style="color: var(--error);">No devices found in any region. Your devices might be offline or not yet registered.</span>';
                showAlert(t('noDevicesAnyRegion'), 'warning');
                // Restore original region selection
                serverSelector.value = currentRegion;
            }
            
            // Re-enable controls
            btn.disabled = false;
            serverSelector.disabled = false;
            btn.innerHTML = '🔄 ' + t('refresh');
        }

        // Display single device (for streaming)
        function displayDevice(device, container) {
            const deviceEl = createDeviceElement(device);
            container.appendChild(deviceEl);
        }

        // Display all devices
        function displayDevices(devices) {
            const devicesList = document.getElementById('devicesList');
            devicesList.innerHTML = '';
            
            if (!devices || devices.length === 0) {
                devicesList.innerHTML = '<p>No devices found</p>';
                return;
            }
            
            devices.forEach(device => {
                displayDevice(device, devicesList);
            });
        }

        // Create device element
        function createDeviceElement(device) {
            const deviceEl = document.createElement('div');
            deviceEl.className = 'device-item';
            
            // Build device info rows
            const infoRows = [];
            
            // Helper to create copyable row
            function createInfoRow(label, value, isToken = false) {
                if (!value || value === 'N/A') return '';
                const rowId = Math.random().toString(36).substr(2, 9);
                return `
                    <div class="info-row">
                        <dt>${label}</dt>
                        <dd class="${isToken ? 'token' : ''}" onclick="copyToClipboard('${value}', '${rowId}')" id="${rowId}">
                            ${value}
                            <span class="copy-hint">Click to copy</span>
                        </dd>
                    </div>
                `;
            }
            
            // Always show these fields
            infoRows.push(createInfoRow(t('model'), device.model));
            infoRows.push(createInfoRow(t('did'), device.did));
            
            // Token - special styling
            if (device.token) {
                infoRows.push(createInfoRow(t('token'), device.token, true));
            }
            
            // Network info - only if available
            if (device.ip && device.ip !== 'undefined') {
                infoRows.push(createInfoRow(t('ip'), device.ip));
            }
            if (device.mac) {
                infoRows.push(createInfoRow(t('mac'), device.mac));
            }
            
            // BLE Key - only if available
            if (device.extra?.ble_key) {
                infoRows.push(createInfoRow(t('bleKey'), device.extra.ble_key, true));
            }
            
            // WiFi info - only if available
            if (device.ssid) {
                infoRows.push(createInfoRow(t('wifi'), device.ssid));
            }
            
            deviceEl.innerHTML = `
                <div class="device-header">
                    <div class="device-name">${device.name || t('unknownDevice')}</div>
                    <div class="device-status">
                        <span class="status-dot ${device.isOnline ? 'online' : ''}"></span>
                        <span>${device.isOnline ? t('online') : t('offline')}</span>
                    </div>
                </div>
                <div class="device-info">
                    ${infoRows.join('')}
                </div>
            `;
            
            return deviceEl;
        }

        // Copy to clipboard function
        function copyToClipboard(text, elementId) {
            navigator.clipboard.writeText(text).then(() => {
                const element = document.getElementById(elementId);
                
                // Add visual feedback to the element
                element.style.transition = 'all 0.3s ease';
                element.style.background = 'rgba(40, 167, 69, 0.2)';
                element.style.borderColor = 'var(--success)';
                
                // Reset after animation
                setTimeout(() => {
                    element.style.background = '';
                    element.style.borderColor = '';
                }, 1500);
            }).catch(err => {
                // debug.error('Failed to copy:', err);
                showAlert(t('failedToCopy'), 'error');
            });
        }

        // Initialize all functionality when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize UI text
            updateUIText();
            
            // Make functions available globally
            window.copyToClipboard = copyToClipboard;
            window.saveSession = saveSession;
            window.switchAuthTab = switchAuthTab;
            window.logout = logout;
            window.loadDevices = loadDevices;
            window.switchLanguage = switchLanguage;
        });
    </script>
</body>
</html>